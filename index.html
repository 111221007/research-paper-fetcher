<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ Research Paper Fetcher</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .form-container {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 1.1em;
        }

        .form-group input[type="text"], .form-group input[type="number"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .checkbox-group {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .checkbox-group h3 {
            margin-bottom: 15px;
            color: #374151;
            font-size: 1.2em;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: #4f46e5;
        }

        .checkbox-item label {
            margin-bottom: 0;
            font-weight: 500;
            color: #4b5563;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }

        .btn-secondary {
            background: #10b981;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #e5e7eb;
            color: #6b7280;
        }

        .btn-outline:hover {
            background: #f3f4f6;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            border-radius: 4px;
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        .status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
            display: none;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .results-container {
            margin-top: 30px;
            display: none;
        }

        .results-box {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .example-hint {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }

        .example-hint h4 {
            color: #0c4a6e;
            margin-bottom: 8px;
        }

        .example-hint p {
            color: #0369a1;
            margin-bottom: 5px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .paper-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }

        .paper-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .paper-meta {
            color: #64748b;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .vercel-notice {
            background: linear-gradient(45deg, #000, #333);
            color: white;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .vercel-notice h4 {
            margin-bottom: 8px;
        }

        .vercel-notice p {
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ Research Paper Fetcher</h1>
            <p>Find and download research papers from Crossref API - Deployed free on Vercel!</p>
        </div>

        <div class="form-container">
            <div class="vercel-notice">
                <h4>‚ö° Powered by Vercel - 100% Free Forever!</h4>
                <p>Lightning-fast global CDN with unlimited bandwidth. All processing happens in your browser!</p>
            </div>

            <form id="fetchForm">
                <div class="form-group">
                    <label for="keyword">üîç Primary Keyword *</label>
                    <input type="text" id="keyword" name="keyword" placeholder="e.g., serverless, machine learning, blockchain" value="serverless" required>
                </div>

                <div class="form-group">
                    <label for="additional_keyword">‚ûï Additional Keyword (optional)</label>
                    <input type="text" id="additional_keyword" name="additional_keyword" placeholder="e.g., performance, security, optimization" value="performance">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="from_year">üìÖ From Year</label>
                        <input type="number" id="from_year" name="from_year" min="1900" max="2030" value="2020" required>
                    </div>

                    <div class="form-group">
                        <label for="to_year">üìÖ To Year</label>
                        <input type="number" id="to_year" name="to_year" min="1900" max="2030" value="2025" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="total_results">üìä Number of Results</label>
                        <input type="number" id="total_results" name="total_results" min="1" max="100" value="20" required>
                    </div>

                    <div class="form-group">
                        <!-- Empty space for symmetry -->
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <h3>‚öôÔ∏è Search Options</h3>
                        <div class="checkbox-item">
                            <input type="checkbox" id="title_filter" name="title_filter" checked>
                            <label for="title_filter">Both keywords must appear in title</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="paper_type_filter" name="paper_type_filter" checked>
                            <label for="paper_type_filter">Journal and Conference papers only</label>
                        </div>
                    </div>
                </div>

                <div class="example-hint">
                    <h4>üí° Example Searches:</h4>
                    <p><strong>Serverless + Performance (2020-2025):</strong> Find recent papers about serverless computing performance</p>
                    <p><strong>Machine Learning + Security (2022-2025):</strong> Find latest ML security-related papers</p>
                    <p><strong>Blockchain + Scalability (2021-2024):</strong> Find blockchain scalability research in specific timeframe</p>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary" id="fetchBtn">
                        <span id="fetchBtnText">üöÄ Fetch Papers</span>
                        <span id="fetchSpinner" class="spinner" style="display: none;"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" id="downloadBtn" disabled>
                        üì• Download CSV
                    </button>
                    <button type="button" class="btn btn-outline" id="clearBtn">
                        üóëÔ∏è Clear Results
                    </button>
                </div>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                </div>

                <div class="status" id="statusMessage"></div>

                <div class="results-container" id="resultsContainer">
                    <h3>üìÑ Fetch Results</h3>
                    <div class="results-box" id="resultsBox"></div>
                </div>
            </form>
        </div>
    </div>

    <script>
        let isLoading = false;
        let fetchedPapers = [];

        document.getElementById('fetchForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (isLoading) return;

            // Validate year range
            const fromYear = parseInt(document.getElementById('from_year').value);
            const toYear = parseInt(document.getElementById('to_year').value);

            if (fromYear > toYear) {
                alert('From Year cannot be greater than To Year');
                return;
            }

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // Convert checkboxes to boolean
            data.title_filter = document.getElementById('title_filter').checked;
            data.paper_type_filter = document.getElementById('paper_type_filter').checked;

            await fetchPapers(data);
        });

        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (fetchedPapers.length > 0) {
                downloadCSV(fetchedPapers);
            }
        });

        document.getElementById('clearBtn').addEventListener('click', function() {
            document.getElementById('resultsBox').innerHTML = '';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('statusMessage').style.display = 'none';
            document.getElementById('downloadBtn').disabled = true;
            fetchedPapers = [];
            showStatus('Cleared. Ready to fetch papers...', 'info');
        });

        async function fetchPapers(data) {
            setLoading(true);
            clearResults();
            showProgress();
            showStatus('üîç Starting paper fetch...', 'info');
            fetchedPapers = [];

            try {
                const keyword = data.keyword.trim();
                const additionalKeyword = data.additional_keyword.trim();
                const fromYear = parseInt(data.from_year);
                const toYear = parseInt(data.to_year);
                const totalResults = Math.min(parseInt(data.total_results), 100);
                const titleFilter = data.title_filter;
                const paperTypeFilter = data.paper_type_filter;

                addResultMessage(`üîç Starting paper fetch...`, 'info');
                addResultMessage(`Primary keyword: '${keyword}'`, 'info');
                addResultMessage(`Additional keyword: '${additionalKeyword}'`, 'info');
                addResultMessage(`Year range: ${fromYear} to ${toYear}`, 'info');
                addResultMessage(`Target results: ${totalResults}`, 'info');
                addResultMessage('-'.repeat(60), 'info');

                const papers = await searchCrossrefAPI(keyword, additionalKeyword, fromYear, toYear, totalResults, titleFilter, paperTypeFilter);

                if (papers && papers.length > 0) {
                    fetchedPapers = papers;
                    displayPapers(papers);
                    document.getElementById('downloadBtn').disabled = false;
                    showStatus(`‚úÖ Completed! Found ${papers.length} papers.`, 'success');
                    addResultMessage(`\nüíæ Found ${papers.length} papers! Click 'Download CSV' to save.`, 'success');
                } else {
                    showStatus('‚ùå No papers found matching your criteria', 'error');
                    addResultMessage('‚ùå No papers found matching your criteria', 'error');
                }

            } catch (error) {
                addResultMessage('‚ùå Error occurred: ' + error.message, 'error');
                showStatus('Error occurred during fetch', 'error');
                console.error('Fetch error:', error);
            } finally {
                setLoading(false);
                hideProgress();
            }
        }

        async function searchCrossrefAPI(keyword, additionalKeyword, fromYear, toYear, totalResults, titleFilter, paperTypeFilter) {
            const papers = [];
            const rowsPerRequest = 20;
            let offset = 0;
            let fetchedCount = 0;
            const maxAttempts = totalResults * 3;
            let processedCount = 0;

            const keywordLower = keyword.toLowerCase().trim();
            const additionalKeywordLower = additionalKeyword.toLowerCase().trim();

            while (fetchedCount < totalResults && processedCount < maxAttempts) {
                try {
                    const remaining = totalResults - fetchedCount;
                    const currentRows = Math.min(rowsPerRequest, remaining * 2);

                    // Build Crossref API URL
                    let url = 'https://api.crossref.org/works?';

                    if (additionalKeyword.trim()) {
                        url += `query.title=${encodeURIComponent(keyword)}+${encodeURIComponent(additionalKeyword)}`;
                    } else {
                        url += `query.title=${encodeURIComponent(keyword)}`;
                    }

                    url += `&filter=from-pub-date:${fromYear},until-pub-date:${toYear}`;

                    if (paperTypeFilter) {
                        url += ',type:journal-article,type:proceedings-article';
                    }

                    url += `&rows=${currentRows}&offset=${offset}&sort=relevance`;

                    addResultMessage(`üì° Fetching papers ${offset + 1} to ${offset + currentRows}...`, 'info');

                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const items = data.message?.items || [];

                    if (items.length === 0) {
                        addResultMessage('‚ö†Ô∏è No more papers found', 'warning');
                        break;
                    }

                    // Process each paper
                    for (const item of items) {
                        processedCount++;

                        if (fetchedCount >= totalResults) break;

                        // Extract title for filtering
                        let title = '';
                        if (item.title && item.title.length > 0) {
                            title = Array.isArray(item.title) ? item.title[0] : item.title;
                        }

                        // Title filtering if enabled
                        if (titleFilter) {
                            const titleLower = title.toLowerCase();
                            const keywordInTitle = titleLower.includes(keywordLower);
                            const additionalInTitle = !additionalKeywordLower || titleLower.includes(additionalKeywordLower);

                            if (!(keywordInTitle && additionalInTitle)) {
                                continue;
                            }
                        }

                        const paper = extractPaperInfo(item, fetchedCount + 1);
                        papers.push(paper);
                        fetchedCount++;

                        if (fetchedCount % 5 === 0 || fetchedCount === totalResults) {
                            addResultMessage(`   ‚úÖ Found ${fetchedCount}/${totalResults} qualifying papers`, 'success');
                        }
                    }

                    offset += currentRows;

                    // Rate limiting
                    await new Promise(resolve => setTimeout(resolve, 200));

                } catch (error) {
                    addResultMessage(`‚ùå Error fetching data: ${error.message}`, 'error');
                    break;
                }
            }

            return papers;
        }

        function extractPaperInfo(item, paperId) {
            // Extract authors
            const authors = [];
            if (item.author) {
                for (const author of item.author) {
                    if (author.given && author.family) {
                        authors.push(`${author.given} ${author.family}`);
                    } else if (author.family) {
                        authors.push(author.family);
                    }
                }
            }

            // Extract title
            let title = '';
            if (item.title && item.title.length > 0) {
                title = Array.isArray(item.title) ? item.title[0] : item.title;
            }

            // Extract abstract
            let abstract = '';
            if (item.abstract) {
                abstract = item.abstract.replace(/<[^>]+>/g, '').replace(/\s+/g, ' ').trim();
            }

            // Extract journal
            let journal = '';
            if (item['container-title'] && item['container-title'].length > 0) {
                journal = Array.isArray(item['container-title']) ? item['container-title'][0] : item['container-title'];
            }

            // Extract year
            let year = '';
            if (item['published-print']?.['date-parts']?.[0]?.[0]) {
                year = item['published-print']['date-parts'][0][0].toString();
            } else if (item['published-online']?.['date-parts']?.[0]?.[0]) {
                year = item['published-online']['date-parts'][0][0].toString();
            }

            return {
                paper_id: `paper_${paperId.toString().padStart(3, '0')}`,
                title: title,
                abstract: abstract,
                authors: authors.length > 0 ? authors.join('; ') : 'Not Available',
                journal: journal,
                year: year,
                volume: item.volume || '',
                issue: item.issue || '',
                pages: item.page || '',
                publisher: item.publisher || '',
                doi: item.DOI || '',
                url: item.URL || '',
                type: item.type || ''
            };
        }

        function displayPapers(papers) {
            const resultsBox = document.getElementById('resultsBox');

            // Add summary
            resultsBox.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>üìä FETCH SUMMARY</h4>
                    <p>Total papers: <strong>${papers.length}</strong></p>
                </div>
            `;

            // Display first few papers as preview
            papers.slice(0, 5).forEach((paper, index) => {
                const paperDiv = document.createElement('div');
                paperDiv.className = 'paper-item';
                paperDiv.innerHTML = `
                    <div class="paper-title">${index + 1}. ${paper.title}</div>
                    <div class="paper-meta">Authors: ${paper.authors}</div>
                    <div class="paper-meta">Journal: ${paper.journal}</div>
                    <div class="paper-meta">Year: ${paper.year}</div>
                    ${paper.doi ? `<div class="paper-meta">DOI: ${paper.doi}</div>` : ''}
                `;
                resultsBox.appendChild(paperDiv);
            });

            if (papers.length > 5) {
                const moreDiv = document.createElement('div');
                moreDiv.style.textAlign = 'center';
                moreDiv.style.padding = '20px';
                moreDiv.style.color = '#64748b';
                moreDiv.innerHTML = `... and ${papers.length - 5} more papers. Download CSV to see all results.`;
                resultsBox.appendChild(moreDiv);
            }
        }

        function downloadCSV(papers) {
            const headers = ['paper_id', 'title', 'abstract', 'authors', 'journal', 'year', 'volume', 'issue', 'pages', 'publisher', 'doi', 'url', 'type'];

            let csvContent = headers.join(',') + '\n';

            papers.forEach(paper => {
                const row = headers.map(header => {
                    const value = paper[header] || '';
                    // Escape quotes and wrap in quotes if contains comma
                    const escapedValue = value.toString().replace(/"/g, '""');
                    return value.includes(',') || value.includes('"') || value.includes('\n')
                        ? `"${escapedValue}"`
                        : escapedValue;
                });
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);

            const keyword = document.getElementById('keyword').value.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '').replace('T', '_');
            link.setAttribute('download', `crossref_papers_${keyword}_${timestamp}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            addResultMessage('üì• CSV file downloaded successfully!', 'success');
        }

        function setLoading(loading) {
            isLoading = loading;
            const fetchBtn = document.getElementById('fetchBtn');
            const fetchBtnText = document.getElementById('fetchBtnText');
            const fetchSpinner = document.getElementById('fetchSpinner');

            fetchBtn.disabled = loading;
            fetchBtnText.style.display = loading ? 'none' : 'inline';
            fetchSpinner.style.display = loading ? 'inline-block' : 'none';
        }

        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
            statusEl.style.display = 'block';
        }

        function clearResults() {
            document.getElementById('resultsBox').innerHTML = '';
            document.getElementById('resultsContainer').style.display = 'block';
        }

        function addResultMessage(message, type) {
            const resultsBox = document.getElementById('resultsBox');
            const timestamp = new Date().toLocaleTimeString();

            const messageEl = document.createElement('div');
            messageEl.style.color = getColorForType(type);
            messageEl.style.marginBottom = '5px';
            messageEl.style.fontFamily = 'Monaco, Menlo, monospace';
            messageEl.style.fontSize = '0.9em';
            messageEl.textContent = `[${timestamp}] ${message}`;

            resultsBox.appendChild(messageEl);
            resultsBox.scrollTop = resultsBox.scrollHeight;
        }

        function getColorForType(type) {
            switch(type) {
                case 'success': return '#059669';
                case 'error': return '#dc2626';
                case 'warning': return '#d97706';
                default: return '#2563eb';
            }
        }

        // Show initial status
        showStatus('Ready to fetch papers... ‚ö° Powered by Vercel!', 'info');
    </script>
</body>
</html>
